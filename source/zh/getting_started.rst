.. _getting-started:

***************
开始
***************

.. _installing-on-win:

在 Windows 计算机上安装 InVEST Workbench
==========================================================

从 https://naturalcapitalalliance.stanford.edu/software/invest 下载InVEST Workbench安装程序。可执行文件将称为“InVEST_<version>_workbench_win32_x64.exe”。双击此.exe以运行安装程序。

第一个屏幕要求您确认许可协议，单击“我同意”继续。

将出现“安装选项”屏幕。您可以选择仅为自己或所有用户安装 InVEST。单击“下一步”。

接下来，选择将安装 Workbench 的文件夹。单击“**安装**”。

Workbench 安装文件夹中可能特别关注以下几点：

+ 一个**资源/文档**文件夹，包含英文、西班牙文和中文的 HTML 格式的 InVEST 用户指南。

+ 一个 **resources/invest** 文件夹，包含构成 InVEST 工具集的已编译 Python 代码。

+ **InVEST <version> Workbench.exe**，这是用于启动 Workbench 的主要可执行文件

+ **卸载 InVEST <version> Workbench.exe**），这将卸载 Workbench。

此外，快捷方式将添加到您的 Windows 开始菜单的 *所有程序 -> InVEST <版本> Workbench*

所有型号的示例数据也可用。要安装这些，请启动 Workbench，然后转到“**设置**”（右上角的齿轮图标）**->“下载示例数据**”。


高级安装
---------------------

InVEST 的windows安装程序为不同的使用情景提供了许多安装选项，包括静默安装和使用本地样例数据。要查看可用的选项，下载安装程序，打开CMD提示符到包含下载安装程序的目录，键入:


.. code-block:: text

    .\InVEST_<version>_x64_Setup.exe /?


.. _installing-on-mac:

在 Mac 上安装 InVEST Workbench 
=============================================

.. note::
  在 Mac OS 10.13“High Sierra”中，需要 InVEST 3.4.0 或更高版本。

  在 Mac OS 11“Big Sur”中，需要 InVEST 3.9.0 或更高版本。

  Mac 二进制文件的数值结果可能与 Windows 二进制文件的结果略有不同（通常在 1e-4 之间）。出于这个原因，我们认为 InVEST 二进制文件“不稳定”，但它们仍然应该提供合理的结果。与往常一样，如果某些内容似乎不起作用，请在论坛上告诉我们： https://community.naturalcapitalalliance.org/

从 https://naturalcapitalalliance.stanford.edu/software/invest 下载InVEST磁盘映像文件。该文件将被称为“InVEST-<version>.dmg”。这包含 InVEST 可执行文件的副本。请注意，从 3.9.0 版本开始，用户指南

和 HISTORY.rst 文件不再包含在 Mac 发行版中;请在线访问这些资源。

安装步骤：
1. 右键单击您下载的“InVEST-<version>.dmg”，然后在上下文菜单中选择*打开*。
2. 在弹出的对话框中，再次单击*打开*。
3. 磁盘映像将打开并指示您将 InVEST 应用程序拖到您的应用程序文件夹。此步骤对于InVEST正常工作至关重要。
4. 转到您的应用程序文件夹，然后从那里打开 InVEST 应用程序。
5. 首次打开InVEST应用程序时，您需要执行以下操作：
1. 右键单击“InVEST”，然后在上下文菜单中选择*打开*。
2. 在弹出的对话框中，再次单击*打开*。
6. 在启动器对话框中，选择要运行的模型，然后单击*启动*。

所有型号的示例数据也可用。要安装这些，请启动 Workbench，然后转到“设置”->“下载示例数据”。

与 Windows 安装程序不同，Mac 发行版不包括用户指南。这可以在 https://naturalcapitalalliance.stanford.edu/software/invest 上在线找到。


InVEST快速入门教程
===========================

本高级教程向您介绍了使用InVEST进行生态系统服务分析所涉及的主要活动。它不是一个详尽的分步技术文本，但确实提供了运行一个InVEST模型所需的步骤、技巧和所需时间的基本内容。虽然每个项目所需的时间差异很大，但每个步骤都提供了一个大致的估计时间:*低* =通常需要不到一天;*中* =不到一周;*高* =一周或更长时间。

1.**安装 InVEST**
- 下载 InVEST，并按照本章的 :ref:`installing-on-win` 或 :ref:`installing-on-mac` 部分中的详细说明进行安装。
- 建议同时安装示例数据。在InVEST Workbench中，可以通过“设置”窗口下载示例数据，方法是单击用户界面右上角的齿轮图标。样本数据的链接也可通过“InVEST网页<https://naturalcapitalalliance.stanford.edu/software/invest>”_获得。
- 安装InVEST所需时间：低
2. **阅读每个感兴趣的型号的用户指南章节**
- 对于每个模型，用户指南都包含背景、方程式、数据要求、结果描述以及对全局数据源和方法的建议。
- 这是有关模型和数据要求的问题的第一个地方。
- 阅读模型章节所需的时间：低
3. **检查模型的样本数据**
- 提供所有型号的示例数据，可在InVEST安装期间安装，或单独下载。
- 提供所有型号的示例数据，可通过 Workbench 设置进行安装，或单独下载。
- 使用 GIS 软件查看空间数据，使用电子表格或文本编辑器查看表格数据。
- 使用这些数据来了解输入和输出并运行模型。
- 以它们为例，说明如何格式化自己的数据。
- 有关更多信息，请参阅本章的 :ref:`using-sample-data` 部分。
- 试用具有样本数据的模型所需的时间：低
4. **为基线案例创建自己的数据**
- 收集模型所需的空间和非空间模型输入。
- 处理您感兴趣的区域收集的数据，以便每个输入都符合 InVEST 要求。
- 大部分处理将使用 GIS 软件完成。
- 许多模型还需要对某些参数进行广泛的文献搜索。
- 请参阅模型的用户指南章节和示例数据，了解数据集应是什么样子的要求和示例。
- 有关一般提示，请参阅本章的 :ref:`formatting-data` 部分。
- 处理量会有很大差异，具体取决于原始源的特定模型输入和格式。
- 最好寻找更多的本地数据源，但如果这些数据源不可用，则通常可以使用更粗略的全局图层和值。每个模型的用户指南附录提供了指向某些全局数据源的指针。
- 为一个模型创建数据所需的时间：高。
5. **创建未来方案**
- 分析场景是可选的，但通常要进行。
- 情景通常基于改变土地利用/土地覆盖、栖息地或土地管理地图，以反映拟议干预措施或气候变化的影响。
- 例如，如果使用利益相关者流程或需要气候建模，则创建场景可能非常耗时。
- 创建方案所需的时间：中到高。
6. **运行模型**
- 使用 InVEST Workbench 用户界面或命令行脚本使用您的数据运行模型。
- 有关更多信息，请参阅本章的 :ref:`running-models` 部分。
- 所需时间：从低到中，具体取决于输入数据的大小和复杂程度，以及正在运行的模型。高分辨率数据和/或大面积感兴趣区域需要更多时间。
7. **检查模型结果**
- 使用 GIS 软件批判性地检查结果 - 模式和值是否有意义？
- 无法解释的模式或异常高或低的值可能表示输入数据存在问题。
- 时间要求：低到中。
8. **校准模型**
- 可选，对于高级筛选分析和/或现场数据不可用于验证，不一定是必需的。
- 但是，如果使用模型结果进行估值，则进行校准非常重要。
- 收集和处理与感兴趣的InVEST模型输出相对应的观测数据。例如，来自水库进水口监测站的沉积物负荷。
- 调整模型输入，以在建模结果和观测数据之间产生一致性。
- 校准可能伴随着灵敏度分析，以确定哪些参数对结果的影响最大。最灵敏的参数是校准调整的好选择。
- 所需时间：中到高。
9. **纳入受益人**
- 将模型结果与人或其他类型的受益人联系起来。这就是它成为生态系统*服务*的地方。
- 收集和预处理有关人员、基础设施或其他相关受益人位置的数据。
- 将InVEST模型结果与受益人数据相结合，通常使用GIS软件完成。
- 时间要求：中等。
10. **估价**
- 生态系统服务的估值，无论是货币的还是非货币的，通常都是复杂且因地制宜的。
- 收集与您正在分析的服务和受益人相关的经济数据。
- 在将模型结果用于估值之前对其进行校准。
- 所需时间：中到高。
11. **传达结果**
- 获得 InVEST 结果后，您将创建地图、表格、图形等，具体取决于将结果传达给受众所需的内容。
- 也可以对结果进行后处理。例如，您可以显示覆盖在 InVEST 结果地图上的保护区地图。或者将多个生态系统服务地图组合成一个“热点”地图，提供最大的综合服务。或者汇总感兴趣区域内的结果。
- 请记住选择您的颜色和符号，以便于广大受众阅读、直观地解释，并且它们能够准确地代表结果。
- 所需时间：从低到中，具体取决于项目需求的复杂性。


GIS 技能
==========

**许多 InVEST 分析步骤都需要中级地理信息系统 （GIS） 技能，尤其是在创建模型输入和处理模型输出时。**

本用户指南假定您具备所需的 GIS 技能，它通常不提供与使用 GIS 软件查看或处理数据相关的说明。您可以使用任何您熟悉的地理空间软件，QGIS和ArcGIS是最常见的。有许多课程和教程可用于学习 GIS 技能和软件，我们建议您在开始使用 InVEST 之前熟悉这些概念和工具。

以下是通常属于 InVEST 分析一部分的 GIS 任务类型的一些示例。这不是一个完整的列表：

+ 查看和导航栅格、矢量和表格数据

+ 对栅格和矢量数据进行符号化

+ 将数据图层重新投影到公共坐标系

+ 将数据图层裁剪到感兴趣区域

+ 将矢量转换为栅格，将栅格转换为矢量

+ 创建新的点、线或面图层

+ 编辑矢量属性表

+ 执行各种栅格数学运算

+ 对栅格值进行重分类

+ 重采样栅格

另请参阅本章的 :ref:`working-with-the-DEM` 部分，该部分提供了有关用于 SDR、NDR、季节性产水量、风景质量和沿海脆弱性模型的数字高程模型 （DEM） 数据的 GIS 处理的一些详细信息。

较早的InVEST版本
=====================
可以在 http://data.naturalcapitalalliance.org/invest-releases/deprecated_models.html 找到 InVEST 的旧版本。请注意，由于关键的未解决的科学问题，许多模型已被弃用，我们强烈建议您使用最新版本的 InVEST。

.. _using-sample-data:

使用示例数据
=================

InVEST 附带示例数据作为格式化数据的指南，并开始了解模型的工作原理。在开始您自己的分析之前，我们强烈建议您下载您感兴趣的模型的示例数据，查看 GIS 中的输入，使用示例数据运行模型，并在 GIS 中检查输出。   

在InVEST Workbench中，可以通过“设置”窗口下载示例数据，方法是单击用户界面右上角的齿轮图标。样本数据的链接也可通过“InVEST网页<https://naturalcapitalalliance.stanford.edu/software/invest>”_获得。

每个模型的示例数据文件夹都包含一个.json文件，您可以使用该文件自动填充大多数模型输入。要使用此功能，请将.json文件拖放到 Workbench 中模型的输入屏幕中，或使用“从文件加载参数”界面导航到.json文件。

对于大多数模型，重要的是其示例数据仅用于测试，例如，不要将空间数据或表值用于您自己的分析，因为它们的来源和准确性未记录在案。一些海洋模型（如沿海脆弱性）带有可用于您自己的应用程序的全球数据集 - 有关更多信息，请参阅这些模型的各个用户指南章节。

为了测试模型，您可以在示例数据文件夹中创建一个名为“output”的工作区文件夹来保存模型结果，或者使用任何适合您的数据组织结构。使用自己的数据后，需要创建一个工作区和输入数据文件夹来保存自己的输入和结果。您还需要重定向该工具以访问您的数据和工作区。

.. _formatting-data:

设置数据格式
====================
在运行 InVEST 之前，有必要格式化数据。尽管本指南的后续章节介绍了如何为每个模型准备输入数据，但所有模型都遵循以下几种通用的格式准则：

+ 数据文件名不应包含空格（例如，栅格文件应命名为“landuse.tif”而不是“land use.tif”）。

+ 对于栅格数据，为了便于使用，首选 TIFF，但您也可以使用 IMG 或 ESRI GRID。

+ 如果使用 ESRI GRID 格式栅格，则其数据集名称的长度不能超过 13 个字符，并且第一个字符不能是数字。TIFF 和 IMG 栅格没有文件名长度限制。使用 ESRI GRID 作为模型界面的输入时，请使用文件“hdr.adf”。

+ 空间数据必须位于投影坐标系（例如 UTM 中），而不是地理坐标系（例如 WGS84）中，并且给定模型运行的所有输入数据必须位于同一投影坐标系中。如果您的数据未被投影，InVEST 将给出错误或不正确的结果。（但也有例外情况，例如沿海漏洞 - 有关具体要求，请参阅模型的用户指南一章。

+ 用作 InVEST 模型输入的每个栅格都必须为栅格的 *NoData* 值分配一个数值数据值。此 *NoData* 值不得被视为有效的模型数据。例如，土地利用/土地覆被栅格可能具有 1 到 30 的有效土地利用代码，因此您可以选择 *NoData* 值 9999。值“nan”不是有效的 NoData 值，在运行模型时将产生错误。您可以通过在 GIS 中查看栅格的属性来检查 *NoData* 值。

+ 虽然 InVEST 3.0 模型现在非常节省内存，但运行模型所需的时间仍受输入数据集大小的影响。如果感兴趣区域较大和/或使用像元大小较小的栅格，则这将增加运行模型所需的内存使用量和时间。如果它们太大，则会发生内存错误。如果发生这种情况，请尝试减小感兴趣区域的大小，或使用较粗分辨率的输入数据。

+ 同样，模型使用的磁盘空间量与输入数据的分辨率成正比。如果感兴趣区域较大和/或使用像元大小较小的栅格，这将增加存储中间模型结果和最终模型结果所需的磁盘空间量。如果没有足够的可用磁盘空间，模型将返回错误。

+ 在另一个程序中打开输入数据文件的情况下运行模型可能会导致错误。确保数据文件未被其他程序使用，以防止数据访问问题。

+ 区域和语言选项：某些语言设置会导致运行模型时出错。例如，使用逗号 （，） 而不是句点 （.） 表示小数的设置会导致模型中出现错误。若要解决此问题，请将计算机的区域设置更改为英语。

+ 在运行模型时，可能需要更改输入表中的值。这通常是通过电子表格程序（如 Excel）或文本编辑器（如 Notepad++）完成的。输入表必须采用 CSV 格式。如果在 Excel 中工作，请务必另存为 CSV。保存 CSV 文件时，请务必使用以下编码之一保存文件：ASCII、UTF-8 或 Signed UTF-8。使用任何其他编码（如 Latin-1）将导致输出文件中的文本呈现不正确，并可能导致模型失败并出现错误。

+ 某些模型需要数据文件（例如，Habitat Quality 模型）和字段（列）名称的特定命名准则，这些准则在每个模型的用户指南章节中定义。请仔细遵循这些操作，以确保数据集有效，否则模型将给出错误。

+ 请记住*使用示例数据集作为格式化数据的指南*。


.. _running-models:

运行模型
==================

当您根据相关模型章节中的说明准备好数据并安装了最新版本InVEST，您就可以运行InVEST模型了。

开始:

+检查您的输入数据。在GIS中查看空间数据，确保值看起来正确，没有应该填充的数据缺失区域，所有数据图层都在相同的投影坐标系统中等。在电子表格或文本编辑器中查看表数据，确保值看起来正确、列名正确，并且以CSV格式保存。

+启动您想要运行的模型，并将您的输入数据添加到用户界面中的每个数据栏内。您可以将图层拖放到数据栏中，或者单击每个数据栏右侧的文件图标来导入您的数据。

+ 输入的路径导致不存在的文件或格式不正确的文件的输入将在输入名称的右侧用红色“X”标记，输入框将以红色勾勒。输入下方将简要说明输入的问题。例如，“输入是必需的，但没有值”表示此输入是必需的，但您尚未用有效信息填写它。如果有任何红色 X，则模型将不会运行。

+注意，每个工具都有一个地方可以输入后缀，这是一个字符串，将被添加到输出文件名*<filename>_Suffix*。添加唯一的后缀可以防止覆盖以前迭代中生成的文件。如果您正在运行多个情景，这尤其有用，因为每个文件名都可以指示情景的名称。

+当所有必填项填写完毕，且没有红色的X时，点击界面上的**运行**按钮。

+处理时间将因脚本以及输入数据集的分辨率和范围而异。每个模型都会打开一个窗口，显示脚本的进度。请务必扫描输出窗口以查找有用的消息和错误。此进度信息也将写入工作区中名为 *InVEST-natcap.invest 的文件中。<型号名称>-log-<timestamp>.txt*。如果您需要联系 NatCap 以获取错误帮助，请始终发送此日志文件，这将有助于调试。有关更多信息，请参阅本章的 :ref:`support-and-error-reporting` 部分。

模型的结果可以在**Workspace**文件夹中找到。主要输出通常位于Workspace文件夹的顶层。还有一个“中间”文件夹，其中包含一些在进行计算时生成的附加文件。虽然通常不需要查看中间结果，但在调试问题或试图更好地理解模型的工作方式时，查看中间结果有时是有用的。阅读模型章节并查看相应的中间文件是理解和评价结果的好方法。本用户指南中的每个模型章节都提供了这些输出文件的描述。

脚本成功完成后，可以通过将空间结果从工作空间添加到 GIS 来查看空间结果。仔细和批判性地看待结果是很重要的。这些价值观有意义吗？这些模式有意义吗？你明白为什么有些地方的值较高而另一些地方的值较低吗？您的输入图层和参数如何驱动结果？ 如果您担心您的结果，并想在用户论坛上询问它，请先查看这些问题。通常，通过查看输入图层中的单位、值或缺失数据，可以很容易地解释意外的高值或低值或缺失数据区域。

.. _support-and-error-reporting:

支持和错误报告
===========================

如果您在运行模型时遇到任何问题，或者对用户指南未涵盖的理论、数据或应用有疑问，请访问用户支持论坛，网址为 https://community.naturalcapitalalliance.org/。*首先，请使用搜索功能查看是否已经提出过类似的问题。很多时候，您的问题或问题已经得到了解答。* 对于错误消息尤其如此 - 您可以在错误消息中搜索几个关键字，并且经常会找到帮助您修复错误的帖子。

如果您没有找到与您的问题或问题相关的现有帖子，或者这些帖子无法解决您的问题，您可以登录并创建一个新帖子。

如果您在运行模型时报告错误，请在论坛帖子中包含以下信息:

+ 您要询问的 InVEST 模型

+ 您正在使用的 InVEST 版本

+ 您已经尝试解决问题但未奏效的内容

+ 模型生成的整个日志文件，位于输出 Workspace 文件夹中 - *InVEST-natcap.invest.<model name>-log-<timestamp>.txt*

培训
--------

根据经费和需求，每年可举办若干次关于InVEST的培训班。有关这些培训的信息将在支持页面上公布，可以在“自然资本项目网站<https://naturalcapitalalliance.stanford.edu/>”上找到。该网站也是关于InVEST、相关出版物和使用案例以及自然资本项目其他活动很好的信息来源。

免费的大规模在线开放课程(MOOC)网站：“英语版<https://www.edx.org/course/introduction-to-the-natural-capital-project-approach/>”和“西班牙语版<https://www.edx.org/course/una-introduccion-al-enfoque-de-capital-natural-ver-2/>”，将提供:

-介绍自然资本项目相关方法

-InVEST简介

-详细介绍了 SDR、沿海脆弱性和城市冷却模型（尽管它们现在都已过时，最近对这些模型进行了更新）。

- 其他生态系统服务分析主题概述，包括情景、受益者和数据来源

- 几个案例研究。


还有一个“YouTube播放列表<https://www.youtube.com/playlist?list= plsfk2ilv3ufnqrzgwfcgyyozzzqzdnj2v7/>与视频培训教程，包括:

- 夏季系列：InVEST简介（InVEST、SDR、沿海脆弱性和交流结果的简要介绍）

- 夏季系列：淡水水质（更详细地介绍了 NDR 和 SDR）

- 夏季系列：城市InVEST（更详细地介绍了城市冷却）

- 简介：牧场生产

- 简介：栖息地质量

- 简介：碳储存

- 简介：季节性产水量

- 简介：城市洪涝风险缓解

我们还有一个“GIS for InVEST 视频系列 <https://naturalcapitalalliance.stanford.edu/software/virtual-training/gis-invest>”_，它提供了使用 InVEST 模型所需的一些 GIS 任务的实践指导。这些都针对 QGIS 和 ArcGIS 提供。


.. _working-with-the-DEM:

使用DEM数据
====================

对于水体模型SDR、NDR和季节性产水量，拥有一个精心准备的数字高程模型(DEM)是至关重要的。它必须没有缺失的数据(NoData值的孔隙)，并且应该正确地表示感兴趣区域的地表水流模式，以便获得准确的结果。

使用最高质量、最佳分辨率的DEM，将减少出现下沉和丢失数据的可能性，并将更准确地表示地形的表面水流，提供所需的详细信息，以便在您感兴趣的范围内做出明智的决策。

虽然每个DEM来源都是不同的，每个研究区域的范围和每个项目的要求也是不同的，但我们通常需要几个步骤来准备一个在InVEST模型中运行的DEM。下面列出了每一个步骤，包括使用ArcGIS和QGIS的相关信息。DEM处理还有其他应用，包括ArcHydro、ArcSWAT、AGWA和BASINS，这里没有介绍这些应用。这只是对DEM编制中涉及的问题和方法的简要概述，而不是GIS教程。

1.**RAW格式的马赛克数据转化为DEM数据**

  如果您已经下载了多个相邻瓦片中的区域的DEM数据，则需要首先将它们拼接在一起以创建单个DEM栅格。在ArcToolbox中，使用Data Management Tools -> Raster -> Raster Dataset -> Mosaic to New Raster。仔细查看输出栅格，以确保瓦片连接边缘的值是正确的。如果不是，请在“马赛克到新栅格”工具中尝试不同的“马赛克方法”参数值。

  在QGIS中，您可以使用Raster -> Miscellaneous -> Merge功能来拼接瓦片。

2.**重新投影到项目的坐标系**

  在ArcGIS (Project Raster工具)或QGIS (Warp工具)中重新投影DEM时，对于ArcGIS中的“重采样技术”或QGIS中的“重采样方法”，重要的是选择BILINEAR或CUBIC。选择NEAREST(或QGIS中的Near)将在感兴趣的区域生成一个格网模式不正确的DEM，这可能只在放大或运行Flow Direction后才会明显。这将创建一个糟糕的流网络和流模式，并导致糟糕的模型结果。

3. **检查缺失数据**
仔细查看 DEM 栅格，确保感兴趣区域内没有缺失数据（由 NoData 像元表示）。如果存在 NoData 单元格，则必须为它们分配值。

对于小孔，一种方法是使用栅格计算器（或条件 -> CON）中的 ArcGIS Focal Mean 函数。例如，在 ArcGIS 10.x::

  Con（IsNull（“theDEM”），FocalStatistics（“theDEM”，NbrRectangle（3,3），“MEAN”），“theDEM”）

也可以使用插值，并且可以更好地处理较大的孔。使用转换工具将 DEM 转换为点 -> 从栅格 ->栅格到点，使用 Spatial Analyst 的插值工具进行插值，然后使用 CON 将插值指定给原始 DEM::

  Con（isnull（[theDEM]）， [interpolated_grid]， [theDEM]）

在QGIS中，尝试填充Nodata工具或GRASS r.neighbors工具。r.neighbors 提供不同的统计类型，包括 Mean。


4.** DEM填洼**

这一步几乎总是必需的。

来自ESRI关于“洼地如何工作”的帮助:“洼地是一个像元或一组空间连接的像元，其流向不能被分配到流向栅格中的八个有效值之一。当所有相邻的像元都高于处理像元时，或者当两个像元相互流入，形成一个双像元循环时，就会发生这种情况。”

洼地通常是由DEM中的误差引起的，它们可以产生不正确的流向栅格。这可能会导致水文处理的几个问题，包括创建一个不连续的流网络。填洼会为异常像元分配新的值，这样它们就能更好地与相邻的栅格衔接。但是这个过程可能会产生新的洼地，所以可能需要迭代过程。

我们发现QGIS Wang and Liu填充工具在填洼方面做得很好，推荐使用(即使是ArcGIS用户)。你也可以通过使用水文（Hydrology ）->填充工具（Fill tool）来使用ArcGIS。可能需要多次运行填充工具（Fill tool）。

5.**验证流网络**

DEM准备好后，可验证流网络。最主要的是查看水流的生成情况，所以你需要一个现实世界中的水流图与之进行比较，这可以是具有地理空间属性的，也可以不是，只要你能直观地进行比较。

由DEM模型生成的流网络应该与已知现实世界中正确的流图上的流紧密匹配。一些InVEST水文模型和支持的InVEST工具RouteDEM输出一个流网络(通常称为*stream.tif*)。这些工具通过首先生成流量方向和流量积累栅格来创建水流(您应该检查此步骤)，然后应用用户输入的“阈值流量累积”（TFA） 值来选择应属于流网络一部分的像素来创建流。例如，如果给定的 TFA 值为 1000，则必须将 1000 像素排入特定像素，然后才能将其视为流的一部分。这相当于说流的累积值为 >= 1000。

使用这些*stream.tif*输出用于评估建模产生的流与现实的匹配程度，并相应地调整阈值流量累积。TFA值越大，河网越粗，支流越少，TFA值越小，支流越多。TFA没有一个“正确”的值，每个您感兴趣的领域和DEM都是不同的。对于测试来说，一个很好的初始值是1000。当比较*stream.tif*与现实世界的水流时，检查您有适当的支流粗细，并确保*stream.tif*的水流是连续的，而不是分割成不连接的片段或单个像素。请注意，建模的水流很少(如果有的话)与现实完全相同，所以不必追求完美，而是让它们合理地接近。如果建模的水流是不连续的，尝试在DEM上做另一次填充，并确保您使用BILINEAR或者CUBIC工具进行重投影。如果无论你怎么尝试，DEM都不能产生连续的流，那么我们建议尝试另一种DEM数据。有几种全球可用的高程数据，当然它们在世界上不同的地方表现不同。

要创建流量累积和流图，而不需要运行整个水文模型，您可以使用InVEST工具RouteDEM，该工具专门用于处理DEM。更多信息请参见:“RouteDEM page < RouteDEM >”。

6.* *创建流域* *

建议从将在分析中使用的DEM中创建流域。如果从其他地方获得流域，则流域的边界可能与用于建模的DEM创建的水文数据无法对齐，从而导致不正确的聚合结果。

有各种各样的工具可以创建流域，包括ArcGIS Watershed tool、QGIS Watershed basins或者r.basins.fill.InVEST还提供了一个名为DelineateIt的工具，效果很好，使用简单，推荐使用。它的优点是能够创造重叠的流域，例如当同一条河上有几个大坝时。更多信息请参见:“delimateit page < delimateit >”。

生成流域后，验证它们是否正确地表示集水区，并且每个流域在字段“ws_id”(或“subws_id”，取决于模型-请参阅您正在使用的水文模型的数据需求部分，根据您的需要而定)中分配了唯一的ID- 请参阅您正在使用的水文模型的“数据需求”部分，以了解所需的内容。

7.** 按照研究区域裁剪DEM**

我们通常建议将DEM裁剪到比您感兴趣的区域略大的区域(通常是流域)。这是为了确保捕捉流域边缘周围的水文情况。这一点尤其重要，因为如果DEM(或/其他模型输入数据)分辨率较低，对流域多边形的裁剪将导致边缘周围大面积的数据缺失。为此，在流域多边形周围创建一个缓冲区，并将DEM裁剪到该缓冲多边形。确保缓冲区的宽度至少与最粗糙模型输入栅格数据的单元格大小相同。例如，如果您的降水数据分辨率为1km，则在流域多边形周围创建一个宽度至少为1km的缓冲区，并使用该缓冲的流域剪辑所有模型输入，包括DEM。然后使用未缓冲的流域作为模型的输入。


